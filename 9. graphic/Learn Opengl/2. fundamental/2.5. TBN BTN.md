# 什么是切线空间(tangent space)

Tangent Space，其实一个坐标系，也就是原点+三个坐标轴决定的一个相对空间，我们只要搞清楚原点和三个坐标轴是什么就可以了。在Tangent Space中，坐标原点就是顶点的位置，其中z轴是该顶点本身的法线方向（N）。另外两个坐标轴就是和该点相切的两条切线。这样的切线本来有无数条，但模型一般会给定该顶点的一个tangent，==这个tangent方向一般是使用和纹理坐标方向相同的那条tangent（T）==。而另一个坐标轴的方向（B）就可以通过normal和tangent的叉乘得到。 

<img src="https://raw.githubusercontent.com/MeiYouDu/pic_bed/master/images/v2-5f2b99607cf1790cdd955149f0436ae2_1440w.webp" alt="img" style="width:80%;float:left" />

<img src="https://picx.zhimg.com/80/v2-cc97e8e2d0eff2084045cf19d61bf58b_1440w.webp?source=1def8aca" alt="img" style="width:80%;float:left" />

<img src="https://raw.githubusercontent.com/MeiYouDu/pic_bed/master/images/v2-af0f3390357b898decbb9e7a50046822_1440w.webp" alt="img" style="width:80%;float:left" />

<img src="https://pica.zhimg.com/80/v2-fc03b4d2c6628f502b3a3daf59d290d2_1440w.webp?source=1def8aca" alt="img" style="float:80%;float:left" />

​        通常我们所见的==法线纹理==是基于原法线信息构建的坐标系来构建出来的。那种偏蓝色的法线纹理其实就是存储了在每个顶点各自的Tangent Space中，法线的扰动方向。也就是说，如果一个顶点的法线方向不变，那么在它的Tangent Space中，新的normal值就是z轴方向，也就是说值为(0, 0, 1)。**但这并不是法线纹理中存储的最终值，因为一个向量每个维度的取值范围在(-1, 1)，而纹理每个通道的值范围在(0, 1)，因此我们需要做一个映射，即pixel = (normal + 1) / 2。这样，之前的法线值(0, 0, 1)实际上对应了法线纹理中RGB的值为(0.5, 0.5, 1)，而这个颜色也就是法线纹理中那大片的蓝色。**这些蓝色实际上说明顶点的大部分法线是和模型本身法线一样的，不需要改变。总结一下就是，法线纹理的RGB通道存储了在每个顶点各自的Tangent Space中的法线方向的映射值。

# 为什么要有切线空间

实际上，法线本身存储在哪个坐标系中都是可以的，例如存储在[World Space](https://zhida.zhihu.com/search?content_id=59509975&content_type=Answer&match_order=1&q=World+Space&zhida_source=entity)、或者[Object Space](https://zhida.zhihu.com/search?content_id=59509975&content_type=Answer&match_order=1&q=Object+Space&zhida_source=entity)、或者Tangent Space中。但问题是，我们并不是单纯的想要得到法线，后续的光照计算才是我们的目的。不管使用哪个坐标系，都面临着一个选择，就是**最后光照计算使用的坐标系究竟是哪个**。对于[Tangent-Space Normal Map](https://zhida.zhihu.com/search?content_id=59509975&content_type=Answer&match_order=1&q=Tangent-Space+Normal+Map&zhida_source=entity)，我们一般就是在Tangent Space里计算的，也就是说，我们需要**把viewDir、lightDir在[Vertex Shader](https://zhida.zhihu.com/search?content_id=59509975&content_type=Answer&match_order=1&q=Vertex+Shader&zhida_source=entity)中转换到Tangent Space中，然后在Fragment Shader对法线纹理采样后，直接进行光照计算**。==（实际情况中，是把扰动的过的法线变换到世界空间或者观测空间中）==

# 进入世界空间

现在回到最初的问题：**如何将法线从切线空间变换到世界空间？**

在世界空间下（我们用XYZ表示，以区别于切线空间），三角形ABC不一定还位于XY平面上。

已知：

- N1’ 在切线空间中的坐标是 (Un, Vn, zn)
- 求：N1’ 在世界空间中的坐标 (Xn, Yn, Zn)

![img](https://raw.githubusercontent.com/MeiYouDu/pic_bed/master/images/v2-33da9a2fc3285b5926b6d439fca63d12_1440w.webp)

如果你学过线性代数，应该能认出这是一个经典的**[基变换](https://zhida.zhihu.com/search?content_id=744095195&content_type=Answer&match_order=1&q=基变换&zhida_source=entity)与坐标变换**问题。

N1’ 本身是一个向量，它从切线空间变换到世界空间时，其坐标会根据两个空间基向量的变换关系进行转换。

假设切线空间的基向量 [T, B, N] 变换到世界空间后变成了 [T’, B’, N’]，那么N1’在世界空间中的坐标就是：

```text
[ T’  B’  N’ ] • [ Un, Vn, zn ]^T
```

这就是TBN矩阵的作用：它本质上就是由切线空间的基向量T、B、N在世界空间下的对应向量T’、B’、N’构成的矩阵——**即 [ T’ B’ N’ ]**。也可以看作是T、B、N向量由切线空间变换到世界空间下的基变换过渡矩阵。

接下来的问题就是：**如何计算出T’、B’、N’？**

# TBN 矩阵的推导

在实际的应用场景中已知：

- 三角形的切线空间坐标，法线
- 三角形的世界空间坐标，法线
- 基于法线贴图计算之后可以获得被扰动之后的法线 $\vec {N}_{per}$

需求解：

-  基于 $\vec{N}_{per}$计算出世界空间中的法线 $\vec{N}_{per_{W}}$

为了将切线空间向量变换到世界空间，需要构建一个转化矩阵即 TBN 矩阵；

通过已知项可以反向求解 TBN 矩阵

**在切线空间中：**

- 向量AB 的坐标可表示为 $\begin{pmatrix}\triangle U1\\\triangle V1\\0\end{pmatrix}$  
- 向量AC 的坐标可表示为 $\begin{pmatrix}\triangle U2\\\triangle V2\\0\end{pmatrix}$  

**在世界空间中：**

- 向量AB 的坐标可通过B点坐标减A点坐标得到，记为 (E1x, E1y, E1z)
- 向量AC 同理，为 (E2x, E2y, E2z)

根据坐标变换关系，我们可以建立如下等式：

$$
\because
\begin{pmatrix}
T^{\prime}\\
B^{\prime}\\
N^{\prime}\\
\end{pmatrix} \
\begin{pmatrix}
\triangle U1&&\triangle U2\\
\triangle V1&&\triangle V2\\
0&&0
\end{pmatrix} = 
\begin{pmatrix}
E1&&E2
\end{pmatrix}\\

\therefore
\begin{pmatrix}
T^{\prime}\\
B^{\prime}\\
\end{pmatrix} =
\begin{pmatrix}
E1&&E2
\end{pmatrix} \begin{pmatrix}
\triangle U1&&\triangle U2\\
\triangle V1&&\triangle V2\\
\end{pmatrix}^{-1}
$$

# 总结

- ==切线空间是一个**基于三角面UV和法线建立的局部坐标系**；==
- ==法线贴图中存储的法线向量是在这个空间下定义的；==
- ==TBN矩阵的作用正是将法线从切线空间变换到世界空间；==
- ==其推导基于边向量在不同空间下的坐标关系，本质是**基变换问题**==


> 作者：Richard Pan
> 链接：https://www.zhihu.com/question/23706933/answer/161968056
> 来源：知乎
> 
>
> 
>作者：御风北斗
> 链接：https://www.zhihu.com/question/23706933/answer/1943798636443054580
> 来源：知乎

